:_module-type: PROCEDURE

[id="migrating-to-the-rhbok-operator_{context}"]
= Migrating to the {rhbok-productname} Operator

The embedded Kueue component, managed as part of {productname-short} 2.23 and earlier versions, is being deprecated. Starting with {productname-short} 2.24, Kueue will be provided by the {rhbok-productname} Operator and the embedded component will no longer be supported.

To ensure continued support and access to enhanced resource management capabilities for your {productname-short} workloads, cluster administrators must migrate from the embedded Kueue to the external {rhbok-productname} Operator. This configuration is supported in {productname-short} 2.23 as a Technology Preview feature. 

ifndef::upstream[]
[IMPORTANT]
====
ifdef::self-managed[]
{rhbok-productname} is currently available in {productname-long} {vernum} as a Technology Preview feature.
endif::[]
ifdef::cloud-service[]
{rhbok-productname} is currently available in {productname-long} as a Technology Preview feature.
endif::[]
Technology Preview features are not supported with {org-name} production service level agreements (SLAs) and might not be functionally complete.
{org-name} does not recommend using them in production.
These features provide early access to upcoming product features, enabling customers to test functionality and provide feedback during the development process.

For more information about the support scope of {org-name} Technology Preview features, see link:https://access.redhat.com/support/offerings/techpreview/[Technology Preview Features Support Scope].
====
endif::[]

You can migrate from embedded Kueue to {rhbok-productname} in two ways:

* Clean migration: This recommended method uninstalls the embedded Kueue first, leaving the cluster in a clean state, and then installs and activates the operator-managed Kueue. This approach avoids potential configuration conflicts.

* Direct migration: This faster method changes control from the embedded Kueue to the {rhbok-productname} Operator-managed Kueue without first uninstalling it. The embedded Kueue is removed automatically during the migration. 

.Prerequisites
* You have cluster administrator privileges for your {openshift-platform} cluster.
* You are using {openshift-platform} 4.18 or later.
* The embedded Kueue component is enabled (that is, the `spec.components.kueue.managementState` field in the `DataScienceCluster` object is `Managed`).

.Procedure
. Optional: When you migrate from the embedded Kueue to {rhbok-productname}, the {productname-short} Operator will automatically move your existing Kueue configuration from the `kueue-manager-config` ConfigMap to the `Kueue` custom resource (CR). If you want to keep the `kueue-manager-config` ConfigMap, run the following command to annotate it:
+
[source,bash]
----
oc annotate configmap kueue-manager-config -n <application-namespace> opendatahub.io/managed=false
----
. Log in to the {openshift-platform} web console as a cluster administrator.
. Optional: If you want to perform a clean migration, remove the embedded Kueue component:
.. In the web console, click *Operators* → *Installed Operators* and then click the {productname-long} Operator.
.. Click the *Data Science Cluster* tab.
.. Click the *default-dsc* object.
.. Click the *YAML* tab.
.. Set `spec.components.kueue.managementState` to `Removed` as shown:
+
[source,YAML]
----
spec:
  components:
    kueue:
      managementState: Removed
----
.. Click *Save*.
.. Wait for the {productname-short} Operator to reconcile, and then verify that the embedded Kueue was removed:
+
* Click the *Details* tab of the *default-dsc* object and confirm that the `KueueReady` status shows `False` with the reason `Removed`.
* Go to *Workloads* → *Deployments*, select the project where {productname-short} is installed (for example, `redhat-ods-applications`), and confirm that Kueue-related deployments (for example, `kueue-controller-manager`) are no longer present.
. Install the {rhbok-productname} Operator on your {openshift-platform} cluster:
.. Follow the steps in link:https://docs.redhat.com/en/documentation/red_hat_build_of_kueue/latest/html/installing_on_openshift_container_platform/install-kueue[Installing Red Hat build of Kueue].
.. Verify that {rhbok-productname} is installed and running:
+
* Go to *Workloads* -> *Pods*, select the project where {rhbok-productname} is installed (for example, `openshift-kueue-operator`), and confirm that the Kueue operator pod is running.
* Go to *Administration* -> *CustomResourceDefinitions* and search for the `ClusterQueue` and `LocalQueue` CRDs to confirm that they are installed.
. Activate the {rhbok-productname} Operator in {productname-short}:
.. In the web console, click *Operators* → *Installed Operators* and then click the {productname-long} Operator.
.. Click the *Data Science Cluster* tab.
.. Click the *default-dsc* object.
.. Click the *YAML* tab.
.. Set `spec.components.kueue.managementState` to `Unmanaged` as shown:
+
[source,YAML]
----
spec:
  components:
    kueue:
      managementState: Unmanaged
----
.. Click *Save*.

.Verification

* Verify that the embedded Kueue is removed.
* Verify that the Kueue component shows a healthy `Unmanaged` status.
* Verify that existing workloads in the queue continue to be processed by the new operator-managed Kueue controllers. You can submit a new test workload to confirm functionality.

.Next steps
* For each data science project that requires workload queuing, apply the `kueue.openshift.io/managed=true` label to the project namespace to opt it in to Kueue management. For more information, see _Configuring workload management with Kueue_.
:_module-type: PROCEDURE

[id="migrating-to-the-rhbok-operator_{context}"]
= Migrating to the {rhbok-productname} Operator

{productname-short} 2.23 and earlier versions include an embedded Kueue component for managing distributed workloads. Starting with {productname-short} 2.24, the embedded Kueue component will be deprecated and Kueue will be provided through {rhbok-productname}, which is installed and managed by the {rhbok-productname} Operator.

You cannot install both the embedded Kueue and the {rhbok-productname} Operator on the same cluster because this creates conflicting controllers that manage the same resources.

{productname-short} does not automatically migrate existing workloads to {rhbok-productname}. Cluster administrators must manually migrate from the embedded Kueue to the {rhbok-productname} Operator to ensure workloads continue using queue management after upgrading. This configuration is supported in {productname-short} 2.23 as a Technology Preview feature.

ifndef::upstream[]
[IMPORTANT]
====
ifdef::self-managed[]
{rhbok-productname} is currently available in {productname-long} {vernum} as a Technology Preview feature.
endif::[]
ifdef::cloud-service[]
{rhbok-productname} is currently available in {productname-long} as a Technology Preview feature.
endif::[]
Technology Preview features are not supported with {org-name} production service level agreements (SLAs) and might not be functionally complete.
{org-name} does not recommend using them in production.
These features provide early access to upcoming product features, enabling customers to test functionality and provide feedback during the development process.

For more information about the support scope of {org-name} Technology Preview features, see link:https://access.redhat.com/support/offerings/techpreview/[Technology Preview Features Support Scope].
====
endif::[]

The Kueue component in {productname-short} supports three management states:

* `Managed`: {productname-short} deploys and manages the embedded Kueue component (current default, being deprecated).
* `Unmanaged`: {productname-short} integrates with the {rhbok-productname} Operator that you install separately.
* `Removed`: Kueue is disabled and uninstalled from {productname-short}. 

To migrate from the embedded Kueue to {rhbok-productname}, choose one of the following methods:

* Clean migration: This recommended method uninstalls the embedded Kueue first, leaving the cluster in a clean state, and then installs and activates the operator-managed Kueue. This approach avoids potential configuration conflicts.

* Direct migration: This faster method changes control from the embedded Kueue to the {rhbok-productname} Operator-managed Kueue without first uninstalling it. The embedded Kueue is removed automatically during the migration. 

.Prerequisites
* You have cluster administrator privileges for your {openshift-platform} cluster.
* You are using {openshift-platform} 4.18 or later.
* You have installed and configured the *cert-manager Operator for {org-name} OpenShift* for your cluster.
* The embedded Kueue component is enabled (that is, the `spec.components.kueue.managementState` field in the `DataScienceCluster` object is set to `Managed`).

.Procedure
. Optional: When you migrate from the embedded Kueue to {rhbok-productname}, the {productname-short} Operator will automatically move your existing Kueue configuration from the `kueue-manager-config` ConfigMap to the `Kueue` custom resource (CR). To retain the `kueue-manager-config` config map, run the following command:
+
[source,bash]
----
oc annotate configmap kueue-manager-config -n <application-namespace> opendatahub.io/managed=false
----
. Log in to the {openshift-platform} web console as a cluster administrator.
. Optional: If you want to perform a clean migration, remove the embedded Kueue component:
.. In the web console, click *Operators* → *Installed Operators* and then click the {productname-long} Operator.
.. Click the *Data Science Cluster* tab.
.. Click the *default-dsc* object.
.. Click the *YAML* tab.
.. Set `spec.components.kueue.managementState` to `Removed` as shown:
+
[source,YAML]
----
spec:
  components:
    kueue:
      managementState: Removed
----
.. Click *Save*.
.. Wait for the {productname-short} Operator to reconcile, and then verify that the embedded Kueue was removed:
+
* Click the *Details* tab of the `default-dsc` object, find the *KueueReady* condition, and confirm that its *Status* is `False` and its *Reason* is `Removed`.
* Go to *Workloads* → *Deployments*, select the project where {productname-short} is installed (for example, `redhat-ods-applications`), and confirm that Kueue-related deployments (for example, `kueue-controller-manager`) are no longer present.
. Install the {rhbok-productname} Operator on your {openshift-platform} cluster:
.. Follow the steps in link:https://docs.redhat.com/en/documentation/red_hat_build_of_kueue/latest/html/installing_on_openshift_container_platform/install-kueue[Installing Red Hat build of Kueue].
.. Verify that {rhbok-productname} is installed and running:
+
* Go to *Workloads* -> *Pods*, select the project where {rhbok-productname} is installed (for example, `openshift-kueue-operator`), and confirm that the Kueue Operator pod is running.
* Go to *Administration* -> *CustomResourceDefinitions* and search for the `ClusterQueue` and `LocalQueue` CRDs to confirm that they are installed.
. Activate the {rhbok-productname} Operator in {productname-short}:
.. In the web console, click *Operators* → *Installed Operators* and then click the {productname-long} Operator.
.. Click the *Data Science Cluster* tab.
.. Click the *default-dsc* object.
.. Click the *YAML* tab.
.. Set `spec.components.kueue.managementState` to `Unmanaged` as shown:
+
[source,YAML]
----
spec:
  components:
    kueue:
      managementState: Unmanaged
----
.. Click *Save*.

. To ensure your existing data science projects continue to be managed by Kueue after the migration, apply the `kueue.openshift.io/managed=true` label to each namespace: 
+
[source,terminal]
----
oc label namespace <project_namespace> kueue.openshift.io/managed=true --overwrite
----
+
Replace `<project_namespace>` with the name of your data science project.
+
[NOTE]
====
Kueue validation and queue enforcement apply only to workloads in namespaces with the `kueue.openshift.io/managed=true` label.
====

.Verification

* Verify that the embedded Kueue is removed.
* Verify that the Kueue component shows a healthy `Unmanaged` status.
* Verify that existing workloads in the queue continue to be processed by the new operator-managed Kueue controllers. You can submit a new test workload to confirm functionality.

.Next steps
* Configure the default `ClusterQueue` with resource flavors and quotas that are appropriate for your cluster's available resources. For more information, see the link:https://docs.redhat.com/en/documentation/red_hat_build_of_kueue[{rhbok-productname}] documentation.
* Create a hardware profile for workload queuing